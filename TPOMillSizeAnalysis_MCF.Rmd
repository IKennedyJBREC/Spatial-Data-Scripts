---
title: "TPO Mill Size Analysis"
description: "Early findings from the Mill-Size Analysis."
author: "Ian Kennedy"
date: "`r Sys.Date()`"
output: 
  distill::distill_article:
    toc: true
    toc_float: true
    toc_depth: 3
    pandoc_args: "--number-sections"
    code_folding: true
---

<style>
html {
  scroll-behavior: smooth;
}
#TOC {
  position: relative;
  z-index: 50;
  background: #ebebeb;     
  padding: 10px;           
  border-radius: 5px;    
  }
@media screen and (max-width: 900px) {
#TOC {
    position: relative;
  }
}
</style>


```{r Setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,  
                      layout="l-body-outset",
                      fig.width=35,  
                      fig.height=20,  
                      out.width = 80,  
                      code_folding = TRUE)
options(scipen = 999, width = 140)
```

```{r Packages, echo=FALSE, include=FALSE}
library(readxl)
library(rmarkdown)
library(tidyverse)
library(distill)
library(magrittr)
library(yaml)
library(ggthemes)
library(kableExtra)
library(formatR)
library(htmlwidgets)
library(htmltools)
library(reactable)
library(knitr)
library(RColorBrewer)
library(viridis)
library(writexl)
```


```{r Calculating Total Volume and Mill Count}

knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})

TPO_Data <- read_excel(path = "C:\\Users\\ikenn\\OneDrive - University of Massachusetts\\Documents - FFRC_TPO\\2021 Mill Data (SY2022)\\SURVEY OUTPUT\\NR_CALLS\\SampleFrame_2021_Updated.xlsx")

State_Code_Conversion <- function(Data){
   Data %>%
    mutate(MILL_STATE = case_when(MILL_STATECD == 9 ~ "CT",
                                MILL_STATECD == 10 ~ "DE",
                                MILL_STATECD == 17 ~ "IL", 
                                MILL_STATECD == 18 ~ "IN",
                                MILL_STATECD == 19 ~ "IA",
                                MILL_STATECD == 20 ~ "KS",
                                MILL_STATECD == 23 ~ "ME",
                                MILL_STATECD == 24 ~ "MD",
                                MILL_STATECD == 25 ~ "MA",
                                MILL_STATECD == 26 ~ "MI",
                                MILL_STATECD == 27 ~ "MN",
                                MILL_STATECD == 29 ~ "MO",
                                MILL_STATECD == 31 ~ "NE",
                                MILL_STATECD == 33 ~ "NH",
                                MILL_STATECD == 34 ~ "NJ",
                                MILL_STATECD == 36 ~ "NY",
                                MILL_STATECD == 38 ~ "ND",
                                MILL_STATECD == 39 ~ "OH",
                                MILL_STATECD == 42 ~ "PA",
                                MILL_STATECD == 44 ~ "RI",
                                MILL_STATECD == 46 ~ "SD",
                                MILL_STATECD == 50 ~ "VT",
                                MILL_STATECD == 54 ~ "WV",
                                MILL_STATECD == 55 ~ "WI"))
}

TPO_Data <- TPO_Data %>%
  mutate(MILL_STATECD = ifelse(MILL_NAME == "James (Jim) Arron", 25, MILL_STATECD))

TPO_Data <- State_Code_Conversion(TPO_Data)

TPO_Data <- TPO_Data %>%
  filter(!IDLE_OOB_DISMANTLED %in% c("IDLE", "OOB", "DISMANTLED")) %>%
  mutate(MILL_NAME = ifelse(!is.na(MILL_NAME_2021), MILL_NAME_2021, MILL_NAME),
         MILL_STREET1 = ifelse(!is.na(MILL_MAILING_ADDRESS), MILL_MAILING_ADDRESS, MILL_STREET1),
         MILL_CITY = ifelse(!is.na(MILL_MAILING_CITY), MILL_MAILING_CITY, MILL_CITY),
         MILL_ZIP_CODE = ifelse(!is.na(MILL_MAILING_ZIP), MILL_MAILING_ZIP, MILL_ZIP_CODE),
         MILL_STATE = ifelse(!is.na(MILL_MAILING_STATE), MILL_MAILING_STATE, MILL_STATE),
         TPOID = ifelse(!is.na(UNIQUE_ID_CORRECTED), UNIQUE_ID_CORRECTED, TPOID),
         MILL_STATE = ifelse(MILL_STATE == "VA", "OH", MILL_STATE)) %>% 
  select(-c(SURVEY_YEAR, MEANING, HS, MILL_STATUS_CD:note, UNIQUE_ID_CORRECTED:MILL_MAILING_ZIP, CONTACT_FIRST_NAME:STATUS_NOTES_2021))


```

```{r Initial Results}

#Calculate the sum of all Mill Volumes
TPO_Data <- TPO_Data %>%
  mutate(TOT_MCF_LOG = log10(TOT_MCF),
         TOT_BF = (TOT_MCF/.158) * 1000,
         TOT_BF_LOG = log10(TOT_BF))

TOT_Volume_NonPulp <- TPO_Data %>%
  filter(!MILL_TYPE_CD %in% c(30, 40, 117)) %>%
  select(TOT_MCF)%>%
  sum(na.rm = FALSE)

TOT_Volume_Pulp <- TPO_Data %>%
  filter(MILL_TYPE_CD %in% c(30, 40, 117)) %>%
  select(TOT_MCF)%>%
  sum(na.rm = FALSE)

MillCount_Pulp <- TPO_Data %>%
  filter(MILL_TYPE_CD %in% c(30, 40, 117)) %>%
  nrow() %>%
  as.numeric()

MillCount_NonPulp <- TPO_Data %>%
  filter(!MILL_TYPE_CD %in% c(30, 40, 117)) %>%
  nrow() %>%
  as.numeric()

TOT_Volume <- TPO_Data %>%
  select(TOT_MCF)%>%
  sum(na.rm = FALSE)

#Calculate Total # of mills

TPO_Data %>%
    nrow() -> TOT_Mills
TOT_Mills <- as.numeric(unlist(TOT_Mills))

#Filter mills with BF > 100,000,000

TPO_Data %>%
  filter(TOT_BF >= 100000000) %>%
  nrow -> TOT_Mills_High_Vol
TOT_Mills_High_Vol <- as.numeric(unlist(TOT_Mills_High_Vol))

```

# Initial Results

- Active Mill Count in Sample = `r TOT_Mills`\
- Agg. Volume - Active Mills in Sample = `r TOT_Volume` MCF\
- Mill Count in Sample - Active Pulp/Paper/Composite & CYards = `r MillCount_Pulp`\
- Agg. Volume - Active Pulp/Paper/Composite Mills/CYards = `r TOT_Volume_Pulp` MCF\
- Mill Count in Sample - Active Non Pulp/Paper/Composite/CYards = `r MillCount_NonPulp`\
- Agg. Volume - Active Non Pulp/Paper/Composite Mills/CYards = `r TOT_Volume_NonPulp` MCF\
- Active 'Outlier' Mills = `r TOT_Mills_High_Vol`\

# Histograms of Log(10) Volume

```{r Histograms}

#Create a histogram of Mill Volumes (Logged MCF)

Hist_Breaks_MCF <- c(seq(-2, 5, by = .5))

ggplot(TPO_Data, aes(TOT_MCF_LOG, label = ..count..), ylim = c(0, 600)) + 
  geom_histogram(breaks = Hist_Breaks_MCF, bins = 14) + 
  scale_x_continuous(breaks= Hist_Breaks_MCF) +
  labs(title = "Histogram of Log(10) MCF") + 
  geom_text(stat = "bin", nudge_y = 10, size = 15, breaks = Hist_Breaks_MCF) +
  theme(text = element_text(family = "serif")) +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
theme(axis.title = element_text(family = 'serif', size = 60), axis.text = element_text(size = 50),
      legend.text = element_text(size = 50), legend.title = element_text(size = 60)) +   
  ylab('Mill Count') + xlab('Log(10) MCF')



```

# State Level Plots
## Log(10) Int'l BF Volume Box & Scatter Plots

```{r Volume Plots}

#Create State-by-State boxplots and scatter plots for Logged BF Volume

ggplot(TPO_Data, aes(x = MILL_STATE, y = TOT_MCF_LOG, color = MILL_STATE)) + 
  geom_jitter(size = 2.5, width = .15) +
  scale_y_continuous(breaks = c(seq(-2,5,.5)), limits = c(-2,5)) + 
  labs(title = "Log(10) MCF by State", y = "Log(10) MCF", x = "State") +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 60), 
        axis.text = element_text(size = 50), legend.position = "none") +
  ylab("Log(10) MCF") + xlab('State')

ggplot(TPO_Data, aes(x = MILL_STATE, y = TOT_MCF_LOG, color = MILL_STATE)) + 
  geom_jitter(size = 2.5, width = .15) +
  geom_hline(yintercept = log10(10*.158), size = .6, color ="red") +
  geom_hline(yintercept = log10(15*.158), size = .6, color ="red") +
  geom_hline(yintercept = log10(45*.158), size = .6, color ="red") +
  scale_y_continuous(breaks = c(seq(-2,5,.5)), limits = c(-2,5)) + 
  labs(title = "Log(10) MCF by State", y = "Log(10) MCF", x = "State") +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 60), 
        axis.text = element_text(size = 50), legend.position = "none") +
  ylab("Log(10) MCF") + xlab('State')



ggplot(TPO_Data, aes(x = MILL_STATE, y = TOT_MCF_LOG, color = MILL_STATE)) + 
  geom_boxplot(outlier.size = 2.5, lwd=1.2) +
  scale_y_continuous(breaks = c(seq(-2,5,.5)), limits = c(-2,5)) + 
  labs(title = "Log(10) MCF by State", y = "Log(10) MCF", x = "State") +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 60), 
        axis.text = element_text(size = 50), legend.position = "none") +
  ylab("Log(10) MCF") + xlab('State')

ggplot(TPO_Data, aes(0, y = TOT_MCF_LOG, color = MILL_STATE)) + 
  geom_violin(width = 1, scale = 'count') + 
  geom_jitter(width = 0.5, size = 2.5) +
  scale_y_continuous(breaks = c(seq(-2,5,1)), limits = c(-2,5)) + 
  labs(title = "Log(10) of MCF by State") +  
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') + 
  theme(axis.title = element_text(family = 'serif', size = 60), legend.position = "none",
        axis.text.x = element_blank(), panel.grid.major.x = element_blank(), axis.text.y = element_text(size = 40)) + 
  ylab("Log(10) MCF") + xlab('State') + 
  facet_wrap(facets = vars(MILL_STATE), ncol = 8)

```

## Volume-Outlier Plot

```{r Outlier Plot}
#Create Bar Chart for High Volume Mills by State

TPO_Data %>%
  group_by(MILL_STATE) %>%
  filter(TOT_BF_LOG >= 8) %>%
  summarize("High_Volume_Mills" = n()) %>%
  ggplot(aes(x = MILL_STATE, y = High_Volume_Mills)) + 
    geom_col() + 
    geom_text(aes(label = High_Volume_Mills), size = 14, nudge_y = .2) + 
    scale_y_continuous(breaks = c(seq(0, 10, 1))) + 
    theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
    theme(axis.title = element_text(family = 'serif', size = 60), axis.text = element_text(family = 'serif', size = 50), panel.grid.major.x = element_blank()) + 
    ylab('High Volume Mills') + 
    xlab('State') +
    labs(title = "High Volume Mills (Log(10) Int'l BF > 8) by State")

# Create High Volume Mill Table

#High_Vol_by_State_Table <- TPO_Data %>% filter(TOT_BF_LOG >= 8) %>% select(MILL_NBR:MTC,  TOT_MCF:TOT_BF_LOG, MILL_STATUS_CD,MILL_STATE) %>% arrange(MILL_STATECD, desc(TOT_BF_LOG))

#kable(High_Vol_by_State_Table, digits = 3, format.args = list(scientific = FALSE), col.names = c("Mill #", "State Code", "Mill Name", "Mailing Address", "City", "Zip Code", "Mill Type Code", "Volume (MCF)", "Volume (Log10 MCF)", "Volume (BF)", "Volume (Log10 BF)", "Status", "State"), align = "ccccccccccccc", caption = "High Volume Mills") %>% kable_styling(font_size = 16) %>% pack_rows(index = table(High_Vol_by_State_Table$MILL_STATE))

```

## Mill Type Plot

```{r Mill Type Plot}
#Create MTC_Summary

MTC_summary <- TPO_Data %>%
  rename('MTC' = 'MILL_TYPE_CD') %>%
  mutate(MTC_Tidy = case_when(MTC %in% c(10,21,22,23,24,25,26) ~ "Sawmill",
                         MTC == 20 ~ "Veneer Mill",
                         MTC %in% c(30,40) ~ "Pulp/Composite Mill",
                         MTC == 50 ~ "Bioenergy Mill",
                         MTC == 60 ~ "House/Cabin Mill",
                         MTC %in% c(70,80,90) ~ "Post/Pole/Piling Mill",
                         MTC == 100 ~ "Residential Firewood Mill",
                         MTC %in% c(110,111) ~ "Other/Misc Mill",
                         MTC == 117 ~ "Concentration Yard",
                         is.na(MTC) ~ "Not Provided"))%>%
  group_by(MILL_STATE, MTC_Tidy) %>%
  arrange(as.factor(MTC_Tidy)) %>%
  summarize("Mill_Type_Count" = n())

#Create bar chart of Mill Type Counts by State
  
MTC_Tidy_Factor_Levels <- c("Sawmill", "Veneer Mill", "Pulp/Composite Mill", "Bioenergy Mill", "House/Cabin Mill", "Post/Pole/Piling Mill",
                            "Residential Firewood Mill", "Other/Misc Mill", "Concentration Yard", "Not Provided")

ggplot(MTC_summary, aes(x = MILL_STATE, y = Mill_Type_Count, 
                        fill = fct_rev(fct_infreq(factor(MTC_Tidy, levels = MTC_Tidy_Factor_Levels))))) +
  geom_col(position = 'stack', width = .8) + 
  labs(title = "Mill Type Counts by State") +
  scale_y_continuous(limits = c(0, 425), breaks = c(seq(from = 0, to = 425, by = 25))) +
  scale_fill_manual(name = "Mill Type", values = turbo(10)) +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 60), axis.text = element_text(size = 50), 
        legend.text = element_text(size = 40), legend.title = element_text(size = 50)) +
  ylab('Mill Count') + xlab('State') +
  guides(fill = guide_legend(title = "Mill Type", reverse = T))


Test <- TPO_Data %>%
  mutate(MTC_Tidy = case_when(MILL_TYPE_CD %in% c(10,21,22,23,24,25,26) ~ "Sawmill",
                         MILL_TYPE_CD == 20 ~ "Veneer Mill",
                         MILL_TYPE_CD %in% c(30,40) ~ "Pulp Mill",
                         MILL_TYPE_CD == 50 ~ "Bioenergy Mill",
                         MILL_TYPE_CD == 60 ~ "House/Cabin Mill",
                         MILL_TYPE_CD %in% c(70,80,90) ~ "Post/Pole/Piling Mill",
                         MILL_TYPE_CD == 100 ~ "Residential Firewood Mill",
                         MILL_TYPE_CD %in% c(110,111) ~ "Other/Misc Mill",
                         MILL_TYPE_CD == 117 ~ "Concentration Yard",
                         is.na(MILL_TYPE_CD) ~ "Not Provided")) %>%
  mutate(MTC_Tidy = as.factor(MTC_Tidy),
         MTC_Tidy = fct_reorder(MTC_Tidy, TOT_MCF_LOG, .desc = TRUE))
Test2 <- Test %>%
  group_by(MTC_Tidy) %>%
  summarise(Count = n())

ggplot(Test, aes(x = MTC_Tidy, y = TOT_MCF_LOG, fill = MTC_Tidy)) + 
  geom_violin(alpha = .5, draw_quantiles = c(.25, .5, .75)) +
  scale_y_continuous(breaks = c(seq(-2,5,.5)), limits = c(-2,5)) + 
  labs(title = "Log(10) MCF by Mill Type", y = "Log(10) MCF", 
       subtitle = "Lines within plots refer to 25th, 50th, & 75th quantiles.", 
       x = "Mill Type") +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 60), 
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size = 50), 
        legend.text = element_text(size = 40), 
        legend.title = element_text(size = 50),
        axis.title.x = element_blank(), 
        panel.grid.major.x = element_blank()) + 
  labs(title = "Log(10) MCF by Mill Type", y = "Log(10) MCF", 
       subtitle = "Lines within plots refer to 25th, 50th, & 75th quantiles.", 
       x = "Mill Type") +
  guides(fill = guide_legend(title = "Mill Type"))

ggplot(Test2, aes(x = MTC_Tidy, y = Count, fill = MTC_Tidy)) + 
  geom_col() +
  scale_y_continuous(breaks = c(seq(0,2500,250)), limits = c(0,2700)) + 
  labs(title = "Mill Count by Mill Type", y = "Mill Count", x = "Mill Type") +
  theme_fivethirtyeight(base_size = 60, base_family = 'serif') + 
  theme(axis.title = element_text(family = 'serif', size = 60), axis.text.y = element_text(size = 50),
        axis.text.x = element_blank(), axis.title.x = element_blank(), panel.grid.major.x = element_blank(), 
        legend.text = element_text(size = 40), legend.title = element_text(size = 50)) +
  geom_text(aes(label = Count), size = 14 , nudge_y = 75) +
  ylab('Mill Count') + guides(fill = guide_legend(title = "Mill Type"))


```

# State Level Means, Medians, & St. Deviations

```{r}

#Calculate means, medians, and standard deviations of logged volumes by state

TPO_summary <- TPO_Data %>%
  rename(MTC = MILL_TYPE_CD) %>%
  select(MILL_STATECD, MILL_STATE, MTC, TOT_MCF_LOG, TOT_BF_LOG) %>%
  group_by(MILL_STATE) %>%
  summarize(meanBF = mean(TOT_BF_LOG, na.rm = TRUE), 
            medianBF = median(TOT_BF_LOG, na.rm = TRUE), 
            meanMCF = mean(TOT_MCF_LOG, na.rm = TRUE), 
            medianMCF = median(TOT_MCF_LOG, na.rm = TRUE), 
            St_Dev = sd(TOT_BF_LOG, na.rm = TRUE), 
            NumberofMills = n()) 

#Create table for means, medians, and standard deviations

knitr::kable(TPO_summary, digits = 4, align = "ccccccc", col.names = c("State", "Mean Log(10) Int'l BF", "Median Log(10) Int'l BF", "Mean Log(10) MCF", "Median Log(10) MCF", "Standard Deviation", "Mill Count"), caption = "Volume-based means, medians, and standard deviations for all mills (omissions not removed) by State. 
      States highlighted in yellow contain at least one outlier mill") %>%
  kable_styling(font_size = 16) %>%
  row_spec(c(6,8,9:11,18,19,23), background = "yellow")

```

# Omission Threshold Plot and Table

```{r}

knit_hooks$set(inline = function(x) {
  prettyNum(x, big.mark=",")
})

#Create Omission Thresholds
#If changing thresholds, make sure to update Function_Volumes.
#If new thresholds are not 1/10000th of top-bounding threshold, make sure to update for-in loop.

TPO_Data <- TPO_Data %>%
  mutate(Volume_Code = case_when(TOT_MCF >= 7.90 ~ 99,
                                 TOT_MCF < 7.90 & TOT_MCF >= 7.11 ~ 5,
                                 TOT_MCF < 7.11 & TOT_MCF >= 6.32 ~ 4.5,
                                 TOT_MCF < 6.32 & TOT_MCF >= 5.53 ~ 4,
                                 TOT_MCF < 5.53 & TOT_MCF >= 4.74 ~ 3.5,
                                 TOT_MCF < 4.74 & TOT_MCF >= 3.95 ~ 3,
                                 TOT_MCF < 3.95 & TOT_MCF >= 3.16 ~ 2.5,
                                 TOT_MCF < 3.16 & TOT_MCF >= 2.37 ~ 2,
                                 TOT_MCF < 2.37 & TOT_MCF >= 1.58 ~ 1.5,
                                 TOT_MCF < 1.58 & TOT_MCF >= 0.79 ~ 1,
                                 TOT_MCF < 0.79 & TOT_MCF > 0.16 ~ 0.5,
                                 TOT_MCF < 0.16 & TOT_MCF > 0 ~ 0.1,
                                 TOT_MCF == 0 ~ 0))

Threshold_Data <- TPO_Data %>%
  filter(Volume_Code != 99 & Volume_Code !=0)

#Create Functions for Mill Count & Volume Omission Data

Threshold_Mills <- function(Data, Volumes){
  Data %>% 
    filter(Volume_Code %in% Volumes) %>%
    select(TOT_MCF) %>%
    nrow -> placeholder 
  placeholder <- as.numeric(unlist(placeholder))
}

Threshold_Volume <- function(Data, Volumes){
  Data %>%
    filter(Volume_Code %in% Volumes) %>%
    select(TOT_MCF) %>%
    sum(na.rm = TRUE)
}

#For-Loop for Mill & Volume Omission Data
Function_Volumes <- Threshold_Data$Volume_Code %>%
  unique() %>%
  sort()

for (i in 1:length(Function_Volumes)){
  assign(paste0("TOT_Mill_Omit_", Function_Volumes[i]*10000), value = Threshold_Mills(Threshold_Data, Function_Volumes[1:i]))
  assign(paste0("TOT_Volume_Omit_", Function_Volumes[i]*10000), value = Threshold_Volume(Threshold_Data, Function_Volumes[1:i]))
}


# Create Vectors for Omitted Mill Counts and Volumes
# Need to change these vectors if changing omission thresholds

Omit_Mill_Count_Vector <- c(TOT_Mill_Omit_1000, TOT_Mill_Omit_5000, TOT_Mill_Omit_10000, TOT_Mill_Omit_15000, 
                            TOT_Mill_Omit_20000, TOT_Mill_Omit_25000, TOT_Mill_Omit_30000, TOT_Mill_Omit_35000, 
                            TOT_Mill_Omit_40000, TOT_Mill_Omit_45000, TOT_Mill_Omit_50000)

Omit_Volume_Vector <- c(TOT_Volume_Omit_1000,TOT_Volume_Omit_5000, TOT_Volume_Omit_10000, TOT_Volume_Omit_15000, 
                        TOT_Volume_Omit_20000, TOT_Volume_Omit_25000, TOT_Volume_Omit_30000, TOT_Volume_Omit_35000, 
                        TOT_Volume_Omit_40000, TOT_Volume_Omit_45000, TOT_Volume_Omit_50000)

TOT_Volume_Vector <- c(TOT_Volume) %>%
  rep.int(times = length(Omit_Volume_Vector))

TOT_Mill_Vector <- c(TOT_Mills) %>%
  rep.int(times = length(Omit_Volume_Vector))


# Convert Vectors to Dataframe

Omit_DF <- data.frame(Omit_Mill_Count_Vector, Omit_Volume_Vector, TOT_Volume_Vector, TOT_Mill_Vector, 
                      row.names = c('0.16 MCF','0.79 MCF', '1.58 MCF', '2.37 MCF','3.16 MCF', '3.85 MCF', '4.74 MCF', '5.53 MCF', '6.32 MCF', '7.11 MCF', '7.90 MCF')) %>%
  mutate(Percent_Omitted = Omit_Mill_Count_Vector/TOT_Mill_Vector*100)

Omit_DF_Kable <- Omit_DF %>%
  mutate(Omit_Volume_Vector = as.integer(Omit_Volume_Vector),
         AggPercent = Omit_Volume_Vector/TOT_Volume*100) 

# Produce Omission Table and Plot

kable(Omit_DF_Kable, digits = 3, align = "cccccc", 
      col.names = c("Omitted Mill Count", "Omitted Volume (MCF)", "Agg. Volume (MCF) in Sample", 
                    "Agg. Mill Count (No Omissions)", "% of Mill Count Omitted", "% of Agg. Volume (MCF) Omitted"), 
      caption = "Omissions by Varying Volume Baselines", 
      format.args = list(big.mark = ",", scientific = FALSE)) %>%
  kable_styling(font_size = 16) %>%
  column_spec(column = 1, bold = TRUE) %>%
  remove_column(columns = c(4,5))

rm(Omit_DF_Kable)

Omit_Vec <- Function_Volumes*10*.158
Omit_DF <- cbind(Omit_DF, Omit_Vec)


#Omit_DF <- Omit_DF %>%
#  mutate(AggPercent = Omit_Volume_Vector/TOT_Volume*100)

Omit_DF %>%
  ggplot(aes(Percent_Omitted, Omit_Volume_Vector, color = as.character(round(Omit_Vec, 2)))) +
  geom_point(size = 6) +
  geom_smooth(size = .8, se = FALSE, color = 'black') +
  scale_x_continuous(breaks = c(seq(0,28,2)), limits = c(0,28)) +
  scale_y_continuous(labels = scales::comma, limits = c(0,2100), breaks = c(seq(0,2100,100)), sec.axis =  sec_axis(~.*100/TOT_Volume_Vector, breaks = c(seq(0,.16,.01)), name = "% of Aggregate Volume (MCF) Omitted")) +
  scale_color_discrete(name = "Omission Threshold (MCF)", labels = function(x) format(sort(as.numeric(x)), big.mark = ",", scientific = FALSE)) +
  labs(title = "Omitted Volumes (MCF) & Mill Counts at Varying Thresholds", subtitle = "Colored #'s refer to the # of mills dropped at each threshold") +
  geom_text(aes(label = Omit_Mill_Count_Vector), size =  16, nudge_y = 70, nudge_x = -.2, show.legend = FALSE) +
  theme_fivethirtyeight(base_size = 40, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 50), plot.margin = unit(c(1,1,1,1), "cm"), 
        axis.title.y.right = element_text(vjust=unit(1.5, "cm")), axis.text = element_text(size = 40),
        legend.text = element_text(size = 60), legend.title = element_text(size = 60)) + 
  ylab("Aggregate Volume (MCF) Omitted") + xlab('% of Mills Omitted')

# Remove Unneeded Vectors

rm(Omit_Mill_Count_Vector, Omit_Volume_Vector, TOT_Volume_Vector, TOT_Mill_Vector, i, Function_Volumes)

rm(TOT_Mill_Omit_1000,TOT_Mill_Omit_5000, TOT_Mill_Omit_10000, TOT_Mill_Omit_15000, TOT_Mill_Omit_20000,
   TOT_Mill_Omit_25000, TOT_Mill_Omit_30000, TOT_Mill_Omit_35000, 
   TOT_Mill_Omit_40000, TOT_Mill_Omit_45000, TOT_Mill_Omit_50000)

rm(TOT_Volume_Omit_1000, TOT_Volume_Omit_5000, TOT_Volume_Omit_10000, TOT_Volume_Omit_15000, TOT_Volume_Omit_20000,
   TOT_Volume_Omit_25000, TOT_Volume_Omit_30000, TOT_Volume_Omit_35000, 
   TOT_Volume_Omit_40000, TOT_Volume_Omit_45000, TOT_Volume_Omit_50000)

# Omit_DF <- Omit_DF %>%
#   mutate(Percent_Vol_Omitted = Omit_Volume_Vector/TOT_Volume * 100)

```

## State-Level Omission Plot and Table

[Omission Threshold Interactive Web Map](https://tinyurl.com/f2nrt3kz)

```{r}

# Find State-by-State Omitted Volume Totals

State_Omit_Count_Levels <- Threshold_Data %>%
  rename(MTC = MILL_TYPE_CD) %>%
  select(MILL_STATECD, MTC:TOT_BF_LOG, Volume_Code) %>%
  group_by(MILL_STATECD, Volume_Code) %>%
  summarize(Mill_Count = n()) %>%
  mutate(Volume_Code = Volume_Code*10000)
State_Omit_Count_Levels <- State_Code_Conversion(State_Omit_Count_Levels)

# Function for summing Omitted Volume by Threshold

Sum_Threshold_Volumes_by_State <- function(Data){
  for (v in 1:length(Data$`Omission Threshold (BF)`)){
    if (v == 1){
      next
    } else if (identical(Data$State[v], Data$State[v-1]) == FALSE){
      next
    } else if (Data$`Omission Threshold (BF)`[v] > Data$`Omission Threshold (BF)`[v-1]){
      Data$`Volume Omitted (BF)`[v] + Data$`Volume Omitted (BF)`[v-1] -> Data$`Volume Omitted (BF)`[v]
    } else{
      break
    }
    }
  Data
  }

#Specify Column Order 

col_order <- c("State", "Omission Threshold (BF)", "Volume Omitted (BF)",
               "Total State Volume (BF)", "% of Volume Omitted")

Threshold_Data <- State_Code_Conversion(Threshold_Data)

# Find Total State Volumes

State_Volumes <- TPO_Data %>%
  select('MILL_STATE', 'TOT_MCF', 'TOT_MCF_LOG') %>%
  group_by(MILL_STATE) %>%
  summarize(State_Volume = sum(TOT_MCF))

# Create Omitted Volume by State DF

Omission_Data <- Threshold_Data %>%
  group_by(MILL_STATE, Volume_Code) %>%
  summarize('Volume Omitted (BF)' = sum(TOT_MCF)) %>%
  mutate('Omission Threshold (BF)' = Volume_Code*10000) %>%
  select(-Volume_Code) %>%
  left_join(State_Volumes, by = 'MILL_STATE') %>%
  rename('Total State Volume (BF)' = 'State_Volume', 'State' = 'MILL_STATE') %>%
  ungroup()


#### THIS IS WHERE THE SCRIPT STOPS WORKING...NEED TO FIGURE OUT Sum_Threshold_Volumes_by_State() function...MAYBE USE fill() instead?

# Sum Volumes by State/Threshold & Create % field comparing Omitted Threshold Volume to Total State Volume
Omission_Data <- Omission_Data %>%
  Sum_Threshold_Volumes_by_State() %>%
  mutate('% of Volume Omitted' = `Volume Omitted (BF)`/`Total State Volume (BF)` * 100)
  

# Reorder columns
Omission_Data <- Omission_Data[, col_order]
rm(col_order)

# Join Omission Data with Omitted Mill Counts
Omission_Data <- Omission_Data %>%
  left_join(State_Omit_Count_Levels, by = c('State' = 'MILL_STATE', 'Omission Threshold (BF)' = 'Volume_Code')) 

Omission_Data <- Omission_Data %>%
  group_by(State) %>%
  mutate(state_Count = sum(Mill_Count)) %>%
  select(-MILL_STATECD)


#Create Omission Template, with NAs for all empty fields.
States <- unique(TPO_Data$MILL_STATE) 
State_Length = as.numeric(length(States))

Thresholds <- unique(Threshold_Data$Volume_Code) %>%
  sort(decreasing = FALSE)*10000

States <- rep.int(States, times = length(Thresholds))

States <- States %>%
  sort(States, decreasing = FALSE)

Thresholds <- Thresholds %>%
  rep.int(times = State_Length)

Columns <- c("State", "Omission Threshold (BF)")

#Create Omission Template, named TestDF
TestDF <- data.frame("State" = States, "Omission Threshold (BF)" = Thresholds)%>%
  group_by(State)

colnames(TestDF) <- Columns

#Join Omission_Data to TestDF, save as Omission_Data
Omission_Data <- TestDF %>%
  left_join(Omission_Data, by = c('State', "Omission Threshold (BF)")) 

#Aggregate Volume/Mill Count by threshold/state
Omission_Data <- Omission_Data %>%
  group_by(State) %>%
  fill(c("Volume Omitted (BF)", "Total State Volume (BF)", "% of Volume Omitted", "Mill_Count", "state_Count"), .direction = "down") 

#Remove unneeded vectors/DFs
rm(Columns, States, Thresholds, State_Length, TestDF)

#Change NA values to 0
Omission_Data[is.na(Omission_Data)] = 0



SumTest <- function(Data){
  for (v in 1:length(Data$Mill_Count)){
    #Pass the first row
    if (v == 1){
    next
    #Pass to the next row if passing to new state
    } else if (Data$State[v] != Data$State[v-1]){
      next
    #If zero & previous row not zero, pull value from previous row
    } else if (Data$Mill_Count[v] == 0 & Data$Mill_Count[v-1] != 0){
      Data$Mill_Count[v-1] -> Data$Mill_Count[v]
      next
    #If not zero, previous row not zero, & volume omitted is greater than the previous row (threshold), 
    #add mill count from previous row to current row's mill count
    } else if (Data$Mill_Count[v] != 0 & Data$Mill_Count[v-1] != 0 & Data$`Volume Omitted (BF)`[v] > Data$`Volume Omitted (BF)`[v-1]){
      Data$Mill_Count[v] + Data$Mill_Count[v-1] -> Data$Mill_Count[v]
      next
    #If not zero, previous row not zero, & volume omitted is equal to the previous row (threshold), pull mill count from previous row
    } else if (Data$Mill_Count[v] != 0 & Data$Mill_Count[v-1] != 0 & Data$`Volume Omitted (BF)`[v] == Data$`Volume Omitted (BF)`[v-1]){
      Data$Mill_Count[v-1] -> Data$Mill_Count[v]
      next
    #Else pass to next row
    } else{
      next
    }
  }
  Data
}

Omission_Data <- Omission_Data %>%
  SumTest()

# write_xlsx(Omission_Data, path = "C:\\Users\\ikenn\\OneDrive - University of Massachusetts\\Documents\\R_Workspace\\Omission_Data.xlsx")

```


```{r State-Level Omission Plots}

pal <- brewer.pal(11, name = "Spectral")
pal <- rev(pal)

# Omission Plots 
Omission_Data %>%
  ggplot(aes(State,`Volume Omitted (BF)`, color  = factor(as.numeric(round(`Omission Threshold (BF)`/1000*.158, 2))))) + 
  geom_point(size = 4) +
  scale_y_continuous(labels = scales::comma, limits = c(0,300), breaks = c(seq(0,300,25))) +
  scale_color_manual(values = pal, name = "Omission Threshold (MCF)") +
  labs(title = "Omitted Volumes (MCF) at Varying Thresholds by State", 
       y = "Omitted Volume (MCF)", x = "State") +
  theme_fivethirtyeight(base_size = 50, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 50), axis.text = element_text(size = 36)) + 
  ylab("Volume (MCF) Omitted") + xlab('State')


Omission_Data %>%
  ggplot(aes(0, `Volume Omitted (BF)`, fill = factor(as.numeric(round(`Omission Threshold (BF)`/1000*.158, 2))))) +
  geom_col(position = 'dodge') +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = pal, name = "Omission Threshold (MCF)") +
  facet_wrap(facets = vars(State), scales = 'free_y', ncol = 6) +
  labs(title = "Omitted Volumes (MCF) at Varying Thresholds by State", y = "Omitted Volume (MCF)", x = "State") +
  theme_fivethirtyeight(base_size = 50, 
                        base_family = 'serif') +
  theme(axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title = element_text(family = 'serif', size = 50),
        panel.grid.major.x = element_blank(), 
        axis.text = element_text(size = 36),
        legend.text = element_text(size = 50), 
        legend.title = element_text(size = 50)) +
  ylab("Volume (MCF) Omitted") 

Omission_Data %>%
  ggplot(aes(0, `% of Volume Omitted`/100, fill = factor(as.numeric(round(`Omission Threshold (BF)`/1000*.158, 2))))) +
  geom_col(position = 'dodge') +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = pal, name = "Omission Threshold (MCF)") +
  facet_wrap(facets = vars(State), scales = 'free_y', ncol = 6) +
  labs(title = "% of Statewide Volume Omitted at Varying Thresholds by State", 
       x = "State") +
  theme_fivethirtyeight(base_size = 50, 
                        base_family = 'serif') +
  theme(axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        axis.title = element_text(family = 'serif', size = 50),
        panel.grid.major.x = element_blank(), 
        axis.text = element_text(size = 36),
        legend.text = element_text(size = 50), 
        legend.title = element_text(size = 50)) + 
  ylab('% of Statewide Volume Omitted') 

Omission_Data <- Omission_Data %>%
  rename(`Omission Threshold (MCF)`= `Omission Threshold (BF)`,
         `Volume Omitted (MCF)` = `Volume Omitted (BF)`,
         `Total State Volume (MCF)` = `Total State Volume (BF)`) %>%
  mutate(`Omission Threshold (MCF)` = case_when(`Omission Threshold (MCF)` == 1000 ~ 0.16,
                                                `Omission Threshold (MCF)` == 5000 ~ 0.79,
                                                `Omission Threshold (MCF)` == 10000 ~ 1.58,
                                                `Omission Threshold (MCF)` == 15000 ~ 2.37,
                                                `Omission Threshold (MCF)` == 20000 ~ 3.16,
                                                `Omission Threshold (MCF)` == 25000 ~ 3.95,
                                                `Omission Threshold (MCF)` == 30000 ~ 4.74,
                                                `Omission Threshold (MCF)` == 35000 ~ 5.53,
                                                `Omission Threshold (MCF)` == 40000 ~ 6.32,
                                                `Omission Threshold (MCF)` == 45000 ~ 7.11,
                                                `Omission Threshold (MCF)` == 50000 ~ 7.90,))


# Omission Table Creation
## Will need to amend rowStyle distinctions if outlier entries are corrected
Omission_Table <- reactable(Omission_Data[,c(1:3,5:6)], groupBy = "State",  defaultPageSize = 24, outlined = TRUE, 
                            resizable = TRUE, wrap = TRUE, highlight = TRUE, theme = reactableTheme(
                           cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"), 
                           headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),

rowStyle = JS("function(rowInfo) {if (rowInfo.row['State'] == 'KS'|| rowInfo.row['State'] == 'ME'||
rowInfo.row['State'] == 'MD'|| rowInfo.row['State'] == 'MI'|| rowInfo.row['State'] == 'MN'|| 
rowInfo.row['State'] == 'OH'|| rowInfo.row['State'] == 'PA'|| rowInfo.row['State'] == 'WI') {
return { backgroundColor: 'yellow' }
}
}"),
                           columns = list(
                            Mill_Count = colDef(name = "# of Mills Omitted", align = "center"),
                            State = colDef(align = "center"), 
                            'Omission Threshold (MCF)' = colDef(align = "center", format = colFormat(separators = TRUE)),
                            'Volume Omitted (MCF)' = colDef(align = "center", format = colFormat(separators = TRUE, digits = 2)),
                            '% of Volume Omitted' = colDef(align = "center", format = colFormat(digits = 3))))

Omission_Table_Titled <- htmlwidgets::prependContent(Omission_Table, 
h2(class = "title", "Omitted Volumes (MCF) at Varying Thresholds by State", 
   style = "text-align: center"), 
h3(class = "caption", "States highlighted in yellow contain at least one volume-outlier mill", 
   style = "text-align: center; font-size: 85%; font-weight: normal"))

Omission_Table_Titled


```

```{r Compare 2020 with Sample, eval=FALSE, include=FALSE}
# Comarison of Sample-Reported & 2020 Survey Response Volumes

# Read 2020 TPO Data & rename problematic State entries

TPO_Data_2020 <- read_csv(file = "C:\\Users\\ikenn\\OneDrive - University of Massachusetts\\Documents\\R_Workspace\\2020_TPO_Data.csv", 
                          col_select = c("MILL_NAME":"MILL_ZIP_CD", "MILL_TYPE_CD":"WOOD_PROCESSED_CD", "MILL_OUTPUT_CAPACITY_ANNUAL", 
                                         "MILL_OUTPUT_CAP_ANNUAL_UNIT_CD", "AMOUNT":"RWAMT_UNIT_MEASURE_CD_OTHERTXT", "TPOID", 
                                         "SW_LBSPERMBF":"HW_LBSPERCORD")) %>%
  select(-'MILL_PHONE')





TPO_Data_2020 <- TPO_Data_2020 %>%
  mutate(MILL_STATE = case_when(MILL_STATE == "0H" ~ "OH",
                                MILL_STATE == "LA" ~ "IA",
                                MILL_NAME == "BRUCE FOREST PRODUCTS" ~ "IL",
                                MILL_NAME == "MANTHEI, INC." ~ "MI",
                                MILL_STATE != "0H" ~ MILL_STATE)) 



# Create DF for Closed/Dismantled Responses in 2020

Closed_Dismantled_2020 <- TPO_Data_2020 %>%
  filter(MILL_STATUS_CD == 4 | MILL_STATUS_CD == 5) %>%
  arrange(desc(WOOD_PROCESSED_CD), desc(AMOUNT)) 

# Join Sample data to 2020 Data

TPO_Data_2020 <- TPO_Data_2020 %>%
  left_join(TPO_Data, by = c("TPOID"="TPOID_2020"), suffix = c("","_Sample"))
  #select(-c(MILL_LAT:SURVEY_YEAR))
  
# Tidy the 2020 Data, still need to parse different Volume Units

TPO_Data_2020 <- TPO_Data_2020 %>%
  select(MILL_NAME:TPOID, MILL_NBR:MILL_STATECD, MTC:TOT_BF_LOG, MILL_STATE_Sample) %>%
  arrange(MILL_STATE) %>%
  mutate(MILL_STATE = case_when(MILL_STATE != MILL_STATE_Sample ~ MILL_STATE_Sample,
                                 MILL_STATE == MILL_STATE_Sample ~ MILL_STATE)) %>%
  filter(MILL_STATUS_CD == 2 | is.na(MILL_STATUS_CD) | ((MILL_STATUS_CD == 3 | MILL_STATUS_CD == 4 | MILL_STATUS_CD == 5)
                                                        & !is.na(AMOUNT))) %>%
  mutate(Amount_Unit = case_when(RWAMT_UNIT_MEASURE_CD == 1 ~ "BF Doyle",
                                 RWAMT_UNIT_MEASURE_CD == 2 ~ "BF Scribner",
                                 RWAMT_UNIT_MEASURE_CD == 5 ~ "BF 1/4 Inch",
                                 RWAMT_UNIT_MEASURE_CD == 6 ~ "BF LT",
                                 RWAMT_UNIT_MEASURE_CD == 11 ~ "MBF Doyle",
                                 RWAMT_UNIT_MEASURE_CD == 12 ~ "MBF Scribner",
                                 RWAMT_UNIT_MEASURE_CD == 15 ~ "MBF 1/4 Inch",
                                 RWAMT_UNIT_MEASURE_CD == 16 ~ "MBF LT",
                                 RWAMT_UNIT_MEASURE_CD == 21 ~ "Standard Cord",
                                 RWAMT_UNIT_MEASURE_CD == 22 ~ "Lake States Cord",
                                 RWAMT_UNIT_MEASURE_CD == 31 ~ "Green Tons",
                                 RWAMT_UNIT_MEASURE_CD == 61 ~ "Pieces",
                                 RWAMT_UNIT_MEASURE_CD == 99 ~ RWAMT_UNIT_MEASURE_CD_OTHERTXT,
                                 is.na(RWAMT_UNIT_MEASURE_CD) ~ RWAMT_UNIT_MEASURE_CD_OTHERTXT)) %>%
  filter(!is.na(Amount_Unit) | !is.na(MILL_OUTPUT_CAPACITY_ANNUAL)) %>%
  arrange(AMOUNT)




# Rename Units

TPO_Data_2020_Tidy <- TPO_Data_2020 %>%
  mutate(Amount_Unit_Tidy = case_when(Amount_Unit == "MMBF INT'L 1/4 IN." |  MILL_NAME %in% c('MILLVILLE LUMBER CO INC', 'DETWEILER LUMBER LLC', 'MATELSKI LUMBER   COMPANY INC', 'TWIN FOREST PRODUCTS LLC', 'RAM FOREST PRODUCTS INC') ~ 'MMBF',
                                      Amount_Unit %in% c('BF','BF 1/4 Inch', 'BF CEDAR SCALE', 'BF Doyle', 'BF LT', 'BF MAINE RULE', 'MAINE SCALE', 'BF Scribner', "INT'L BF") |  MILL_NAME %in% c('ROUGH CUT SAWMILL', 'LEGGES PORTABLE MILLING') ~ 'BF',
                                      Amount_Unit %in% c('MAINE RULE MBF', 'MBF 1/4 Inch', 'MBF Doyle', 'MBF LT', 'MBF Scribner') ~ 'MBF',
                                      Amount_Unit %in% c('Green Tons', 'Metric Tons') ~ 'GT',
                                      Amount_Unit == 'Lake States Cord' ~ 'LSC',
                                      Amount_Unit == 'Standard Cord' ~ 'SC',
                                      Amount_Unit %in% c('LOGS', 'Million square feet', 'Pieces') ~ Amount_Unit))  

# Create DF for units in BF, MBF, & MMBF

TPO_Data_2020_BF <- TPO_Data_2020_Tidy %>%
  filter(Amount_Unit_Tidy %in% c('BF', 'MBF', 'MMBF'), !is.na(AMOUNT) | !is.na(MILL_OUTPUT_CAPACITY_ANNUAL)) 

# Convert Amounts to numeric

TPO_Data_2020_BF$AMOUNT <- as.numeric(as.character(TPO_Data_2020_BF$AMOUNT)) 


# Convert MBF/MMBF to BF

TPO_Data_2020_BF <- TPO_Data_2020_BF %>%
  mutate(AMOUNT_BF = case_when(Amount_Unit_Tidy == 'BF' ~ AMOUNT,
                            Amount_Unit_Tidy == 'MBF' ~ AMOUNT*1000, 
                            Amount_Unit_Tidy == 'MMBF' ~ AMOUNT*1000000))  


# Fix Mills with Amounts > 100,000,000 BF

TPO_Data_2020_BF <- TPO_Data_2020_BF %>%
mutate(AMOUNT_BF_Tidy = case_when(AMOUNT_BF >= 100000000 ~ AMOUNT_BF/1000,
                                  AMOUNT_BF < 100000000 ~ AMOUNT_BF,
                                  is.na(AMOUNT_BF) ~ MILL_OUTPUT_CAPACITY_ANNUAL)) %>%
  select(MILL_NAME, MILL_STATE, MILL_OUTPUT_CAPACITY_ANNUAL:RWAMT_UNIT_MEASURE_CD, TPOID, TOT_BF:TOT_BF_LOG, Amount_Unit:AMOUNT_BF_Tidy) %>%
  mutate(AMOUNT_BF_Tidy = case_when(MILL_NAME == 'COLBY LUMBER CO INC' ~ 4000000,
                                    MILL_NAME == 'SOLTS SAWMILL' ~ 1500000,
                                    MILL_NAME != 'SOLTS SAWMILL' & MILL_NAME != 'COLBY LUMBER CO INC' ~ AMOUNT_BF_Tidy))

Edited_Mills <- c('SOLTS SAWMILL', 'COLBY LUMBER CO INC', 'MILLVILLE LUMBER CO INC', 'DETWEILER LUMBER LLC', 'MATELSKI LUMBER   COMPANY INC', 'TWIN FOREST PRODUCTS LLC', 'RAM FOREST PRODUCTS INC', 'ROUGH CUT SAWMILL', 'LEGGES PORTABLE MILLING')


TPO_Data_2020_BF %>%
  filter(AMOUNT_BF_Tidy >= 1000000 & AMOUNT_BF_Tidy < 10000000) %>%
ggplot(aes(TOT_BF, AMOUNT_BF_Tidy)) +
  geom_point(aes(color = MILL_NAME %in% Edited_Mills)) +
  geom_smooth(method = "lm", se = FALSE, fullrange = TRUE) +
  geom_abline() +
  scale_x_continuous(labels = scales::comma,limits = c(0,10000000), breaks = c(seq(0,10000000, 1000000))) +
  scale_y_continuous(labels = scales::comma,limits = c(0,10000000), breaks = c(seq(0,10000000, 1000000))) +
  theme_fivethirtyeight(base_size = 20, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 20)) + ylab('2020 Survey Response Volume (BF)') + 
  xlab('Sample-Reported Volume (BF)') +
  labs(title = "2020 Response Volumes vs. Sample-Reported Volumes (BF)", 
       caption = "Figure 12. 2020 Response Volumes vs. Sample-Reported Volumes for Response Volumes < 1,000,000 BF") +
  scale_color_discrete(name = "Manual Volume Modification?", labels = c("No", "Yes")) 

TPO_Data_2020_BF %>%
  filter(AMOUNT_BF_Tidy >= 1000000 & AMOUNT_BF_Tidy < 10000000) %>%
  ggplot(aes(TOT_BF, AMOUNT_BF_Tidy)) +
  geom_point(aes(color = MILL_NAME %in% Edited_Mills)) + 
  geom_smooth(se = FALSE) +
  geom_abline() +
  scale_x_continuous(labels = scales::comma, limits = c(0,10000000), breaks = c(seq(0,100000000,1000000))) +
  scale_y_continuous(labels = scales::comma, limits = c(0,10000000), breaks = c(seq(1000000,100000000,1000000))) +
  theme_fivethirtyeight(base_size = 20, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 20)) + ylab('2020 Survey Response Volume (BF)') + 
  xlab('Sample-Reported Volume (BF)') +
  labs(title = "2020 Response Volumes vs. Sample-Reported Volumes (BF)", 
       caption = "Figure 13. 2020 Response Volumes vs. Sample-Reported Volumes for Response Volumes, 1,000,000 BF - 10,000,000 BF") +
  scale_color_discrete(name = "Manual Volume Modification?", labels = c("No", "Yes"))

TPO_Data_2020_BF %>%
  filter(AMOUNT_BF_Tidy >= 10000000) %>%
  ggplot(aes(TOT_BF, AMOUNT_BF_Tidy)) +
  geom_point(aes(color = MILL_NAME %in% Edited_Mills)) + 
  geom_smooth(se = FALSE) +
  geom_abline() +
  scale_x_continuous(labels = scales::comma, breaks = c(seq(0, 80000000, 10000000))) +
  scale_y_continuous(labels = scales::comma, limits = c(0, 100000000), breaks = c(seq(0, 80000000, 10000000))) +
  theme_fivethirtyeight(base_size = 20, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 20)) + ylab('2020 Survey Response Volume (BF)') + 
  xlab('Sample-Reported Volume (BF)') +
  labs(title = "2020 Response Volumes vs. Sample-Reported Volumes (BF)", 
       caption = "Figure 14. 2020 Response Volumes vs. Sample-Reported Volumes for Response Volumes >= 10,000,000 BF") +
  scale_color_discrete(name = "Manual Volume Modification?", labels = c("No", "Yes"))


# Full Sample Comparison
TPO_Data_2020_BF %>%
  filter(MILL_NAME != "SMITH FOREST PRODUCTS" & MILL_NAME != "BERG REINVIGORATIONS LLC" & MILL_NAME != "INDIANA VENEERS CORP") %>%
  ggplot(aes(TOT_BF, AMOUNT_BF_Tidy)) +
  geom_point(aes(color = MILL_NAME %in% Edited_Mills)) +
  geom_smooth(data = TPO_Data_2020_BF,se = FALSE, method = "lm") +
  geom_abline() +
  scale_x_continuous(labels = scales::comma, limits = c(0, 100000000), breaks = c(seq(0, 100000000, 10000000))) +
  scale_y_continuous(labels = scales::comma, limits = c(0, 100000000), breaks = c(seq(0, 100000000, 10000000))) +
  theme_fivethirtyeight(base_size = 20, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 20)) +
  ylab('2020 Survey Response Volume (BF)') +
  xlab('Sample-Reported Volume (BF)') +
  labs(title = "2020 Response Volumes vs. Sample-Reported Volumes (BF)",
       caption = "Figure 15. 2020 Response Volumes vs. Sample-Reported Volumes for Full Sample") +
  scale_color_discrete(name = "Manual Volume Modification?", labels = c("No", "Yes"))

TestPlotDF <- TPO_Data_2020_BF%>%
  filter(MILL_NAME != "SMITH FOREST PRODUCTS" & MILL_NAME != "BERG REINVIGORATIONS LLC" & MILL_NAME != "INDIANA VENEERS CORP")

TestPlot <- TestPlotDF %>%
  filter(MILL_NAME != "SMITH FOREST PRODUCTS" & MILL_NAME != "BERG REINVIGORATIONS LLC" & MILL_NAME != "INDIANA VENEERS CORP") %>%
  ggplot(aes(TOT_BF, AMOUNT_BF_Tidy)) +
  stat_smooth(se = FALSE, fullrange = FALSE, n = 360) 

# TestPlot +
#   geom_point(data = Low,aes(x = TOT_BF, y = AMOUNT_BF_Tidy,color = MILL_NAME %in% Edited_Mills)) +
#   geom_abline() +
#   scale_x_continuous(labels = scales::comma,limits = c(0,1000000), breaks = c(seq(0,1000000,100000))) +
#   scale_y_continuous(labels = scales::comma,limits = c(0,1000000), breaks = c(seq(0,1000000,100000))) +
#   theme_fivethirtyeight(base_size = 20, base_family = 'serif') +
#   theme(axis.title = element_text(family = 'serif', size = 20)) + ylab('2020 Survey Response Volume (BF)') + 
#   xlab('Sample-Reported Volume (BF)') +
#   labs(title = "2020 Response Volumes vs. Sample-Reported Volumes (BF)", 
#        caption = "Figure 12. 2020 Response Volumes vs. Sample-Reported Volumes for Response Volumes < 1,000,000 BF") +
#   scale_color_discrete(name = "Manual Volume Modification?", labels = c("No", "Yes"))

  
#rm(TPO_Data_2020, TPO_Data_2020_BF, TPO_Data_2020_Tidy, Closed_Dismantled_2020, Edited_Mills)

```

```{r 2021 Comparisons, eval=FALSE, include=FALSE}
TPO_2021 <- read_csv(file = "C:\\Users\\kenne\\Documents\\OneDrive - University of Massachusetts\\Documents - FFRC_TPO\\2021 Mill Data (SY2022)\\SURVEY OUTPUT\\TELEFORM CSV\\2021_TPO_Mail_Phone_7.12.22.CSV")

TPO_2021 <- TPO_2021 %>%
  mutate(Ver_Check = str_detect(TPOID, pattern = "^\\d{2}-2021-\\d+-\\d+$")) %>%
  filter(Ver_Check == TRUE) %>%
  select(-Ver_Check)

TPO_2021 <- TPO_2021 %>%
  select(MILL_NAME, MILL_STATE, TPOID, AMOUNT, RWAMT_UNIT_MEASURE_CD:RWAMT_UNIT_MEASURE_CD_OTHERTXT)

TPO_Data <- TPO_Data %>%
  mutate(TPOID = paste0(MILL_STATECD, "-2021-", MILL_NBR, "-", MILL_TYPE_CD))

Test <- TPO_2021 %>%
  left_join(TPO_Data, by = 'TPOID') 

Test <- Test %>%
  filter(!is.na(AMOUNT)) %>%
  select(MILL_NAME.x:RWAMT_UNIT_MEASURE_CD_OTHERTXT, MILL_NAME.y, TOT_MCF, TOT_MCF_LOG:TOT_BF_LOG, MILL_STATE.y)

Test <- Test %>%
  mutate(Amount_Unit = case_when(RWAMT_UNIT_MEASURE_CD == 1 ~ "BF Doyle",
                                 RWAMT_UNIT_MEASURE_CD == 2 ~ "BF Scribner",
                                 RWAMT_UNIT_MEASURE_CD == 5 ~ "BF 1/4 Inch",
                                 RWAMT_UNIT_MEASURE_CD == 6 ~ "BF LT",
                                 RWAMT_UNIT_MEASURE_CD == 11 ~ "MBF Doyle",
                                 RWAMT_UNIT_MEASURE_CD == 12 ~ "MBF Scribner",
                                 RWAMT_UNIT_MEASURE_CD == 15 ~ "MBF 1/4 Inch",
                                 RWAMT_UNIT_MEASURE_CD == 16 ~ "MBF LT",
                                 RWAMT_UNIT_MEASURE_CD == 21 ~ "Standard Cord",
                                 RWAMT_UNIT_MEASURE_CD == 22 ~ "Lake States Cord",
                                 RWAMT_UNIT_MEASURE_CD == 31 ~ "Green Tons",
                                 RWAMT_UNIT_MEASURE_CD == 61 ~ "Pieces",
                                 RWAMT_UNIT_MEASURE_CD == 99 ~ RWAMT_UNIT_MEASURE_CD_OTHERTXT,
                                 is.na(RWAMT_UNIT_MEASURE_CD) ~ RWAMT_UNIT_MEASURE_CD_OTHERTXT)) 
Test <- Test %>%
   mutate(Amount_Unit_Tidy = case_when(Amount_Unit == "MMBF INT'L 1/4 IN."  ~ 'MMBF',
                                      Amount_Unit %in% c('BF','BF 1/4 Inch', 'BF CEDAR SCALE', 'BF Doyle', 'BF LT', 'BF MAINE RULE', 'MAINE SCALE', 'BF Scribner', "INT'L BF", 'Maine Scale', 'cedar scale', 'Cedar Scale') ~ 'BF',
                                      Amount_Unit %in% c('MAINE RULE MBF', 'MBF 1/4 Inch', 'MBF Doyle', 'MBF LT', 'MBF Scribner', 'MBF Maine Rule', 'MBF') ~ 'MBF',
                                      Amount_Unit %in% c('Green Tons', 'Metric Tons') ~ 'GT',
                                      Amount_Unit == 'Lake States Cord' ~ 'LSC',
                                      Amount_Unit == 'Standard Cord' ~ 'SC',
                                      Amount_Unit %in% c('LOGS', 'Million square feet', 'Pieces') ~ Amount_Unit)) 

Test <- Test %>%
  mutate(AMOUNT_BF = case_when(Amount_Unit_Tidy == 'BF' ~ AMOUNT,
                            Amount_Unit_Tidy == 'MBF' ~ AMOUNT*1000, 
                            Amount_Unit_Tidy == 'MMBF' ~ AMOUNT*1000000))  


Test %>%
  ggplot(aes(TOT_BF, AMOUNT_BF_Tidy)) +
  geom_point(aes(color = MILL_NAME %in% Edited_Mills)) +
  geom_smooth(data = TPO_Data_2020_BF,se = FALSE, method = "lm") +
  geom_abline() +
  scale_x_continuous(labels = scales::comma, limits = c(0, 100000000), breaks = c(seq(0, 100000000, 10000000))) +
  scale_y_continuous(labels = scales::comma, limits = c(0, 100000000), breaks = c(seq(0, 100000000, 10000000))) +
  theme_fivethirtyeight(base_size = 20, base_family = 'serif') +
  theme(axis.title = element_text(family = 'serif', size = 20)) +
  ylab('2020 Survey Response Volume (BF)') +
  xlab('Sample-Reported Volume (BF)') +
  labs(title = "2020 Response Volumes vs. Sample-Reported Volumes (BF)",
       caption = "Figure 15. 2020 Response Volumes vs. Sample-Reported Volumes for Full Sample") +
  scale_color_discrete(name = "Manual Volume Modification?", labels = c("No", "Yes"))


# Need to figure out unit issues!!!



Test <- Omission_Data %>%
  mutate(`Omission Threshold (BF)` = as.factor(`Omission Threshold (BF)`)) %>%
  SharedData$new(key = ~`Omission Threshold (BF)`, group = "Threshold (BF)")

Test1 <- Omission_Data %>%
  mutate(`Omission Threshold (BF)` = as.factor(`Omission Threshold (BF)`)) %>%
  SharedData$new(key = ~State, group = "Threshold (BF)")

```